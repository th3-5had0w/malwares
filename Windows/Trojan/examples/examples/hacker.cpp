#include <iostream>
#include <WinSock2.h>
#include <WS2tcpip.h>
#include <string>
#include <time.h>

#pragma comment(lib, "ws2_32.lib")

char host[NI_MAXHOST];
//char serv[NI_MAXSERV];

void first_phase() {
	WSADATA wsadata;
	WORD ver = MAKEWORD(2, 2);
	WSAStartup(ver, &wsadata);

	SOCKET sock = socket(AF_INET, SOCK_STREAM, 0);
	sockaddr_in hint;
	int port = 30000;
	hint.sin_family = AF_INET;
	hint.sin_port = htons(port);
	hint.sin_addr.S_un.S_addr = INADDR_ANY;
	bind(sock, (sockaddr*)&hint, sizeof(hint));
	listen(sock, NI_MAXHOST);
	sockaddr_in client;
	int clientlen = sizeof(client);
	SOCKET client_socket = accept(sock, (sockaddr*)&client, &clientlen);
	ZeroMemory(host, NI_MAXHOST);
	//ZeroMemory(serv, NI_MAXSERV);
	//getnameinfo((sockaddr*)&client, clientlen, host, NI_MAXHOST, serv, NI_MAXSERV, 0);
	inet_ntop(AF_INET, &client.sin_addr, host, NI_MAXHOST);
	std::cout << host << " connected at " << ntohs(client.sin_port) << std::endl;
	closesocket(sock);
	WSACleanup();
}

void fourth_phase() {
	WSADATA wsadata;
	WORD ver = MAKEWORD(2, 2);
	WSAStartup(ver, &wsadata);
	SOCKET sock = socket(AF_INET, SOCK_STREAM, 0);
	sockaddr_in hint;
	int port = 1412;
	hint.sin_family = AF_INET;
	hint.sin_port = htons(port);
	inet_pton(AF_INET, host, &hint.sin_addr);
	connect(sock, (sockaddr*)&hint, sizeof(hint));
	std::string userInput = "initdata";
	char buf[8192];
	while (userInput.size() > 0 && strcmp(userInput.c_str(), "exit") != 0) {
		ZeroMemory(buf, 8192);
		std::cout << "$";
		std::getline(std::cin, userInput);
		send(sock, userInput.c_str(), userInput.size()+1, 0);
		int bytesrecved = recv(sock, buf, 8192, 0);
		std::cout << "<Server>" << std::string(buf, 0, bytesrecved) << std::endl;
	}
	closesocket(sock);
	WSACleanup();
	std::cout << "Press Enter to exit..." << std::endl;
	getchar();

}

int main() {
	first_phase();
	std::cout << "Waiting for 1 seconds..." << std::endl;
	Sleep(1000);
	fourth_phase();
	return 0;
}